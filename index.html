<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>無限恐怖：凡人的智慧 (修復版)</title>
    <style>
        :root { --bg: #050505; --term: #33ff00; --ui: #1a1a1a; --bd: #444; --acc: #b71c1c; --rare: #ffd700; --chu: #e0e0e0; }
        
        /* 核心佈局修正：使用 dvh 避免手機瀏覽器遮擋 */
        body { 
            background: var(--bg); color: #ccc; font-family: 'Microsoft JhengHei', sans-serif; 
            margin: 0; height: 100dvh; width: 100vw; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        
        /* Intro Window */
        #intro-win { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; justify-content:center; align-items:center; }
        .win-box { background:#c0c0c0; border:2px outset #fff; width:90%; max-width:400px; padding:2px; box-shadow:5px 5px 0 #333; color:black;}
        .win-head { background:#000080; color:white; padding:4px; font-weight:bold; display:flex; justify-content:space-between; }
        .win-content { padding:20px; text-align:center; font-size:1.1em; }
        .win-btn { border:2px outset white; background:#c0c0c0; padding:8px 25px; cursor:pointer; margin:10px; font-weight:bold; font-size: 1em;}
        .win-btn:active { border-style: inset; }
        
        /* Job Select Layout (Fix: Fixed Header/Footer, Scrollable Body) */
        #char-select { 
            display:none; flex-direction:column; height:100%; width: 100%; background: #111; 
            position: absolute; top: 0; left: 0; z-index: 100;
        }
        .job-header { 
            padding: 10px 15px; background: #0e0e0e; border-bottom:1px solid #333; 
            display:flex; justify-content:space-between; align-items:center; flex-shrink: 0;
        }
        .job-grid-wrapper {
            flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch;
        }
        .job-grid { 
            display:grid; grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap:10px; 
            padding-bottom: 20px; /* Space for scrolling */
        }
        .job-footer {
            padding: 15px; background: #1a1a1a; border-top: 1px solid #333; 
            flex-shrink: 0; text-align: center; z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            display: flex; justify-content: center; gap: 10px; align-items: center;
        }

        .job-card { 
            background: #222; border:1px solid #444; padding:10px; cursor:pointer; font-size: 0.85em; 
            display: flex; flex-direction: column; justify-content: space-between; transition: 0.2s; min-height: 100px;
        }
        .job-card:hover { border-color: var(--term); background: #2a2a2a; }
        .job-card.selected { border: 2px solid var(--acc); background:#2d1a1a; transform: scale(1.02); }
        .job-name { color: #fff; font-weight:bold; font-size:1.1em; margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px; }
        .job-item { color: var(--term); font-size: 0.9em; margin-top:3px; }
        
        /* Main UI */
        #main-ui { display:none; height:100%; flex-direction:column; width: 100%; }
        header { background:#0e0e0e; padding:8px 15px; border-bottom:1px solid var(--acc); display:flex; justify-content:space-between; align-items:center; font-size: 0.9em; flex-shrink: 0;}
        
        #game-body { flex:1; display:flex; overflow:hidden; position: relative; }
        
        /* Sidebar (Left) */
        #sidebar { 
            flex: 0 0 28%; background:#111; border-right:1px solid #333; padding:8px; overflow-y:auto; font-size:0.8em; 
            min-width: 80px;
        }
        .sb-title { color: #fff; border-bottom: 1px solid #444; margin: 15px 0 5px 0; padding-bottom: 2px; font-weight: bold; }
        
        /* Log Area (Right) */
        #log-area { 
            flex: 1; background:#000; padding:15px; overflow-y:auto; font-family:'Consolas', monospace; line-height:1.6; font-size: 0.95em; 
            -webkit-overflow-scrolling: touch;
        }
        
        /* Common UI Elements */
        .stat-row { display:flex; justify-content:space-between; margin-bottom: 4px; }
        .plus-btn { width: 18px; height: 18px; font-size: 12px; padding: 0; line-height: 16px; background: #333; color: var(--term); border: 1px solid #555; cursor: pointer; }

        /* Logs */
        .log-txt { margin-bottom:6px; color:#aaa; }
        .log-sys { color:yellow; }
        .log-dmg { color:#ff4444; }
        .log-heal { color:#00e676; }
        .log-skill { color:#00b0ff; font-weight:bold; }
        .log-item { color: var(--rare); }
        .log-luck { color: gold; text-shadow:0 0 5px orange; font-weight:bold; }
        .log-save { color:#e040fb; font-weight:bold; border: 1px dashed #e040fb; padding: 10px; margin: 10px 0; background: #110011; }
        .log-plot { color: #eee; font-style: italic; margin: 8px 0; border-left: 3px solid #555; padding-left: 10px; }
        .log-chu { color: #fff; background: #333; padding: 5px; border-left: 3px solid #fff; font-weight: bold; margin: 5px 0; }
        
        /* Controls */
        #controls { padding:8px; background:#1a1a1a; display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; border-top:1px solid #333; min-height: 65px; flex-shrink: 0; z-index: 20;}
        button.act-btn { background:#333; color:#eee; border:1px solid #555; padding:10px; cursor:pointer; border-radius:4px; font-size:0.9em; transition: 0.2s; touch-action: manipulation; }
        button.act-btn:hover { background:#444; border-color: #777; }
        button.btn-special { background:#b71c1c; border-color:#ff5252; color:white; }
        button.btn-team { background:#1565c0; color:#fff; border-color:#42a5f5; grid-column: span 2; }
        button.btn-start { background:var(--acc); color:white; padding: 10px 20px; font-weight: bold; border: 1px solid #ff5252; font-size: 1em; }
        
        /* Modals */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:none; justify-content:center; align-items:center; }
        .event-box { width:90%; max-width:550px; background:#222; border:2px solid var(--term); padding:20px; display:flex; flex-direction:column; max-height: 90vh; overflow-y: auto; }
        .event-title { font-size: 1.2em; color: var(--term); font-weight: bold; margin-bottom: 10px; }
        .choice-btn { background:#333; color:white; border:1px solid #555; padding:12px; margin-bottom:8px; text-align:left; cursor:pointer; border-radius: 4px; }
        .choice-btn:hover { background:#444; border-color: var(--term); }
        .choice-luck { border-color: gold; color: gold; font-weight:bold; }
        .choice-chu { border: 1px solid #fff; background: #222; color: #fff; font-weight: bold; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .shop-box { width:95%; height:90vh; background:#1e1e1e; border:1px solid #555; display:flex; flex-direction:column; max-width: 800px; }
        .shop-list { flex:1; overflow-y:auto; padding:5px; }
        .shop-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; border-bottom: 1px solid #333; padding: 10px; align-items: center; }
        .btn-buy { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; cursor: pointer; min-width: 80px; }
        .btn-buy:disabled { background: #222; color: #555; border-color: #333; cursor: not-allowed; }
    </style>
</head>
<body>

<!-- 1. Intro -->
<div id="intro-win">
    <div class="win-box">
        <div class="win-head"><span>SYSTEM_ALERT</span><span>X</span></div>
        <div class="win-content">
            <p>想明白生命的意義嗎？</p>
            <p>想真正的...活著嗎？</p>
            <div style="margin-top:20px;">
                <button class="win-btn" onclick="goToSelect()">YES</button>
                <button class="win-btn" onclick="window.close()">NO</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. Select Job -->
<div id="char-select">
    <div class="job-header">
        <h3 style="color:var(--acc); margin:0; font-size: 1.1em;">意識載入：選擇前世</h3>
        <button class="act-btn" style="padding:6px 12px; font-size: 0.8em;" onclick="refreshJobs()">⟳ 刷新列表</button>
    </div>
    
    <div class="job-grid-wrapper">
        <div class="job-grid" id="job-container"></div>
    </div>
    
    <div class="job-footer">
        <input type="text" id="player-name" value="鄭吒" style="padding:10px; width:120px; background:#222; border:1px solid #555; color:white; text-align:center; border-radius:4px;" placeholder="輸入名字">
        <button class="act-btn btn-start" onclick="startGame()">確認開始</button>
    </div>
</div>

<!-- 3. Main Game -->
<div id="main-ui">
    <header>
        <div><span id="ui-name"></span> | <span style="color:gold" id="ui-pts">0</span> 獎勵點</div>
        <div id="ui-loc" style="color:#00e676">主神空間</div>
    </header>
    
    <div id="game-body">
        <div id="sidebar">
            <div class="sb-title">人物屬性</div>
            <div id="stat-list"></div>
            
            <div class="sb-title">持有物品</div>
            <div id="inv-list"></div>
            
            <div class="sb-title">技能與血統</div>
            <div id="skill-list"></div>
            
            <div class="sb-title">輪迴隊友</div>
            <div id="team-list"></div>
        </div>
        
        <div id="log-area">
            <div class="log-sys">連接主神光球... 數據同步完成。</div>
        </div>
    </div>
    
    <div id="controls"></div>
</div>

<!-- Event Modal -->
<div id="event-modal" class="modal">
    <div class="event-box">
        <div class="event-title" id="ev-title"></div>
        <div style="margin-bottom:15px; color:#eee; line-height:1.5;" id="ev-desc"></div>
        <div id="ev-choices" style="display:flex; flex-direction:column;"></div>
    </div>
</div>

<!-- Shop Modal -->
<div id="shop-modal" class="modal">
    <div class="shop-box">
        <div style="display:flex; padding:10px; background:#111;">
            <button class="act-btn" style="flex:1" onclick="renderShop('items')">輔助道具</button>
            <button class="act-btn" style="flex:1" onclick="renderShop('skills')">血統技能</button>
            <button class="act-btn" style="background:#b71c1c; flex:0 0 50px;" onclick="document.getElementById('shop-modal').style.display='none'">X</button>
        </div>
        <div class="shop-list" id="shop-content"></div>
    </div>
</div>

<script>
/* --- 1. Content Libraries --- */

// 職業庫 (含道具特效)
const allJobs = [
    {n:"特種兵", s:{str:15, agi:12, vit:15, int:8, spr:10, luc:5}, i:"衝鋒槍", d:"軍隊精英。", eff:"攻擊力+30"},
    {n:"職業殺手", s:{str:10, agi:18, vit:10, int:12, spr:15, luc:5}, i:"匕首", d:"高爆發。", eff:"攻擊力+20，高暴擊"},
    {n:"黑客", s:{str:5, agi:8, vit:5, int:20, spr:12, luc:8}, i:"筆記本電腦", d:"破解科技。", eff:"必過智力判定"},
    {n:"神棍", s:{str:5, agi:8, vit:5, int:12, spr:12, luc:20}, i:"護身符", d:"運氣極高。", eff:"運氣+10，迴避靈異傷害"},
    {n:"外科醫生", s:{str:8, agi:15, vit:8, int:15, spr:10, luc:6}, i:"急救包", d:"擅長治療。", eff:"戰鬥後自動回血"},
    {n:"拳擊手", s:{str:18, agi:10, vit:15, int:5, spr:8, luc:5}, i:"拳擊手套", d:"肉搏強悍。", eff:"空手傷害+15"},
    {n:"友善好鄰居", s:{str:10, agi:20, vit:10, int:12, spr:12, luc:10}, i:null, k:"蜘蛛感應", d:"【特殊】隱藏天賦。", eff:"自帶蜘蛛感應"},
    {n:"吸血鬼後裔", s:{str:12, agi:12, vit:12, int:10, spr:10, luc:5}, i:null, k:"吸血鬼血統", d:"【特殊】渴望鮮血。", eff:"自帶吸血"},
    {n:"古武傳人", s:{str:15, agi:12, vit:12, int:8, spr:15, luc:5}, i:"長槍", k:"爆炸", d:"【特殊】內氣運行。", eff:"自帶爆炸技能"},
    {n:"司機", s:{str:10, agi:12, vit:10, int:8, spr:8, luc:8}, i:"扳手", d:"擅長駕駛。", eff:"攻擊力+10"},
    {n:"小說家", s:{str:6, agi:7, vit:6, int:18, spr:18, luc:8}, i:"筆記本", d:"精神力高。", eff:"精神判定優勢"},
    {n:"運動員", s:{str:14, agi:14, vit:14, int:6, spr:8, luc:6}, i:"球棒", d:"體能優秀。", eff:"攻擊力+15"},
    {n:"廚師", s:{str:12, agi:10, vit:10, int:8, spr:8, luc:8}, i:"菜刀", d:"刀法精湛。", eff:"攻擊力+15"},
    {n:"警察", s:{str:10, agi:10, vit:10, int:10, spr:10, luc:10}, i:"警槍", d:"射擊訓練。", eff:"攻擊力+20"},
    {n:"小偷", s:{str:6, agi:18, vit:6, int:10, spr:8, luc:15}, i:"萬能鑰匙", d:"開鎖專家。", eff:"必過敏捷/開鎖判定"},
    {n:"流浪漢", s:{str:8, agi:8, vit:14, int:8, spr:10, luc:12}, i:"破碗", d:"生存力強。", eff:"HP+20"}
];

// 商店道具 (特效實裝)
const shopItems = [
    {n:"無限沙鷹", c:500, type:"weapon", atk:40, d:"無限子彈，攻擊+40"},
    {n:"高斯狙擊槍", c:3000, type:"weapon", atk:250, d:"極高穿透，攻擊+250"},
    {n:"強效止血噴霧", c:100, type:"consumable", d:"回復200HP"},
    {n:"納戒", c:1500, type:"acc", d:"空間道具，每戰回血+10"},
    {n:"綠魔滑板", c:2000, type:"acc", d:"飛行道具，速度+30"},
    {n:"防彈背心", c:300, type:"armor", d:"被動減傷20"},
    {n:"復活真經(殘)", c:8000, type:"special", d:"劇情道具，可復活一名隊友"},
    {n:"高震動粒子刀", c:800, type:"weapon", atk:90, d:"攻擊+90，破防"}
];

// 商店技能
const shopSkills = [
    {n:"蜘蛛感應", c:1500, type:"passive", effect:"dodge", val:0.4, d:"被動：40%機率閃避攻擊。"},
    {n:"吸血鬼血統", c:2500, type:"passive", effect:"suck", val:0.3, d:"被動：將造成傷害的30%轉化為生命。"},
    {n:"爆炸", c:2000, type:"active", effect:"buff", val:3, costHp:20, d:"主動：消耗20HP，本回合攻擊力x3。"},
    {n:"毀滅", c:5000, type:"active", effect:"buff", val:6, costHp:50, d:"主動：【爆炸進階】消耗50HP，本回合攻擊力x6。"},
    {n:"心靈震爆", c:1500, type:"active", effect:"stun", val:1, mp:30, d:"主動：消耗30MP，擊暈敵人1回合。"},
    {n:"紅炎", c:1500, type:"active", effect:"dmg", val:2.5, mp:20, d:"主動：消耗20MP，造成2.5倍力量傷害。"},
    {n:"治癒術", c:800, type:"active", effect:"heal", val:150, mp:40, d:"主動：消耗40MP，回復150HP。"},
    {n:"聖光氣", c:1200, type:"active", effect:"dmg", val:4, mp:30, d:"主動：對黑暗生物造成4倍精神傷害。"},
    {n:"點線魔眼", c:3000, type:"active", effect:"crit", val:5, mp:60, d:"主動：消耗60MP，造成5倍無視防禦傷害。"},
    {n:"風之矢", c:1000, type:"active", effect:"dmg", val:3, mp:20, d:"主動：造成3倍敏捷屬性傷害。"},
    {n:"混元一氣功", c:800, type:"passive", effect:"stat", d:"被動：全屬性+10。"},
    {n:"寫輪眼", c:2000, type:"passive", effect:"crit_rate", d:"被動：增加20%暴擊率與命中。"},
    {n:"戶愚呂弟肌肉", c:1800, type:"passive", effect:"stat_str", d:"被動：力量+30，體力+20。"},
    {n:"AT力場", c:4000, type:"active", effect:"block", val:500, mp:80, d:"主動：生成500點絕對防禦護盾。"},
    {n:"九陽神功", c:3000, type:"passive", effect:"regen", val:30, d:"被動：每回合自動回復30HP。"}
];

// 同伴庫
const teammatePool = [
    {n:"零點", skill:{n:"狙擊", type:"dmg", val:400}},
    {n:"詹嵐", skill:{n:"治療", type:"heal", val:200}},
    {n:"趙櫻空", skill:{n:"刺殺", type:"dmg", val:300}},
    {n:"張杰", skill:{n:"念動", type:"stun", val:1}},
    {n:"霸王", skill:{n:"掃射", type:"dmg", val:250}}
];

/* --- 2. State --- */
let player = { n:"", hp:100, maxHp:100, mp:100, maxMp:100, pts:0, items:[], skills:[], stats:{}, teammates:[], geneActive:false, movieCount:0 };
let gameState = { loc: "Lobby", movieName: "", stage: 0, maxStage: 0, geneUsed: false };
let combatState = { enemy:null, playerBuffs:{} };
let currentJobs = [];
let selectedJob = null;

/* --- 3. UI Functions --- */

function goToSelect() {
    document.getElementById('intro-win').style.display = 'none';
    document.getElementById('char-select').style.display = 'flex';
    refreshJobs();
}

function refreshJobs() {
    currentJobs = [...allJobs].sort(() => 0.5 - Math.random()).slice(0, 10);
    const c = document.getElementById('job-container');
    c.innerHTML = "";
    selectedJob = null;
    
    currentJobs.forEach(j => {
        const d = document.createElement('div');
        d.className = "job-card";
        let effTxt = j.eff ? `(${j.eff})` : "";
        d.innerHTML = `
            <div>
                <div class="job-name">${j.n}</div>
                <div style="color:#aaa; font-size:0.9em">力${j.s.str} 速${j.s.agi} 體${j.s.vit} 智${j.s.int}</div>
                <div style="color:#888; font-size:0.8em; margin-top:5px;">${j.d}</div>
            </div>
            <div>
                ${j.i ? `<div class="job-item">自帶: ${j.i}<br><span style="font-size:0.8em;color:#888">${effTxt}</span></div>` : ""}
                ${j.k ? `<div class="job-item" style="color:var(--rare)">天賦: ${j.k}</div>` : ""}
            </div>
        `;
        d.onclick = () => {
            document.querySelectorAll('.job-card').forEach(x=>x.classList.remove('selected'));
            d.classList.add('selected');
            selectedJob = j;
        }
        c.appendChild(d);
    });
}

function startGame() {
    if(!selectedJob) { alert("請選擇前世！"); return; }
    player.n = document.getElementById('player-name').value || "鄭吒";
    player.stats = {...selectedJob.s};
    if(selectedJob.i) player.items.push(selectedJob.i);
    if(selectedJob.k) player.skills.push(shopSkills.find(s=>s.n===selectedJob.k));
    
    recalcStats();
    player.hp = player.maxHp;
    player.mp = player.maxMp;

    document.getElementById('char-select').style.display = 'none';
    document.getElementById('main-ui').style.display = 'flex';
    updateUI();
    log("傳送完成。歡迎來到主神空間。", "log-sys");
    if(selectedJob.n==="友善好鄰居") log("【蜘蛛感應】已激活，你能感知危險。", "log-skill");
    
    renderLobby();
}

function recalcStats() {
    player.maxHp = player.stats.vit * 10 + 50;
    player.maxMp = player.stats.spr * 5 + 50;
    if(player.items.includes("破碗")) player.maxHp += 20;
    // Passive Skill Stats
    if(player.skills.find(s=>s.n==="混元一氣功")) { /* Just base for now */ }
}

function updateUI() {
    document.getElementById('ui-name').innerText = player.n;
    document.getElementById('ui-pts').innerText = player.pts;
    document.getElementById('ui-loc').innerText = gameState.loc === "Lobby" ? "主神空間" : gameState.movieName;
    
    const slist = document.getElementById('stat-list');
    let isLobby = gameState.loc === "Lobby";
    let h = `<div class="stat-row">HP <span style="color:#ff4444">${Math.floor(player.hp)}/${player.maxHp}</span></div>`;
    h += `<div class="stat-row">MP <span style="color:#4fc3f7">${Math.floor(player.mp)}/${player.maxMp}</span></div>`;
    ["str","agi","vit","int","spr","luc"].forEach(k => {
        let label = {str:"力量",agi:"速度",vit:"體力",int:"智力",spr:"精神",luc:"運氣"}[k];
        h += `<div class="stat-row"><span>${label}:${player.stats[k]}</span> ${isLobby ? `<button class="plus-btn" onclick="upStat('${k}')">+</button>` : ""}</div>`;
    });
    slist.innerHTML = h;

    document.getElementById('inv-list').innerHTML = player.items.map(i=>`<div class="sb-item">·${i}</div>`).join('');
    document.getElementById('skill-list').innerHTML = player.skills.map(k=>`<div class="sb-item" style="color:#4fc3f7">★${k.n}</div>`).join('');
    document.getElementById('team-list').innerHTML = player.teammates.map(t=>`<div class="sb-item" style="color:#ffa726">☺${t.n}</div>`).join('');
    
    if(player.geneActive) slist.innerHTML += `<div style="color:red;font-weight:bold;text-align:center;">基因鎖開啟中</div>`;
}

function log(msg, cls="log-txt") {
    const d = document.createElement('div');
    d.className = cls;
    d.innerHTML = `> ${msg}`;
    const area = document.getElementById('log-area');
    area.appendChild(d);
    area.scrollTop = area.scrollHeight;
}

function upStat(k) {
    if(player.pts >= 100) {
        player.pts -= 100;
        player.stats[k] += 5;
        recalcStats();
        if(k==='vit') player.hp += 50;
        if(k==='spr') player.mp += 25;
        updateUI();
    }
}

/* --- 4. Logic: Lobby --- */
function renderLobby() {
    gameState.loc = "Lobby";
    updateUI();
    const c = document.getElementById('controls');
    c.innerHTML = `
        <button class="act-btn btn-special" style="grid-column: span 2" onclick="startMovie()">進入恐怖片</button>
        <button class="act-btn" onclick="openShop()">主神兌換</button>
        <button class="act-btn" onclick="fullHeal()">全身修復(50)</button>
    `;
}
function fullHeal() {
    if(player.pts >= 50) {
        player.pts -= 50;
        player.hp = player.maxHp;
        player.mp = player.maxMp;
        updateUI();
        log("修復完畢。", "log-heal");
    }
}

/* --- 5. Logic: Movie System --- */
function startMovie() {
    gameState.loc = "Movie";
    gameState.stage = 0;
    gameState.geneUsed = false;
    
    // Movie Sequence
    if(player.movieCount === 0) {
        gameState.movieName = "生化危機一";
        gameState.maxStage = 6;
        log("目標：《生化危機一》 (新手保護)", "log-sys");
        setTimeout(()=>log("馬修·埃迪森：「新人，素質不錯。」", "log-plot"), 1000);
    } 
    else if(player.movieCount === 2) { // 3rd movie (index 2)
        gameState.movieName = "死神來了";
        gameState.maxStage = 10;
        log("目標：《死神來了》", "log-sys");
        log("警告：本場無怪物，只有死神製造的意外。", "log-dmg");
    }
    else {
        const titles = ["異形", "咒怨", "神鬼傳奇", "猛鬼街", "變形金剛"];
        gameState.movieName = titles[Math.floor(Math.random()*titles.length)];
        gameState.maxStage = 8;
        log(`目標：《${gameState.movieName}》`, "log-sys");
        if(gameState.movieName==="異形") log("太空船內一片死寂，酸性血液腐蝕地板的聲音傳來...", "log-plot");
        if(gameState.movieName==="咒怨") log("這是一棟陰森的日式宅邸，閣樓傳來詭異的爬行聲...", "log-plot");
        if(gameState.movieName==="神鬼傳奇") log("哈姆納塔的風沙遮天蔽日，聖甲蟲在沙層下蠕動...", "log-plot");
    }
    updateUI();
    renderStage();
}

function renderStage() {
    const c = document.getElementById('controls');
    c.innerHTML = `<button class="act-btn" style="grid-column: span 4; background:#222; height:50px;" onclick="nextStage()">繼續前進 / 探索</button>`;
}

function nextStage() {
    gameState.stage++;
    
    // Final Destination Logic
    if(gameState.movieName === "死神來了") {
        if(gameState.stage > gameState.maxStage) { endMovie(); return; }
        generateDeathEvent();
        return;
    }

    // Resident Evil 1 Logic
    if(player.movieCount === 0) {
        if(gameState.stage === 1) triggerEventFixed("雷射通道", "死亡光線襲來！", "敏捷閃避", "黑客破解");
        else if(gameState.stage === 3) startCombat("喪屍", 60, 10);
        else if(gameState.stage === 5) triggerEventFixed("紅後重啟", "拔出主板？", "暴力拔除", "說服傭兵");
        else if(gameState.stage === 6) startCombat("爬行者(弱化)", 150, 20, true);
        else renderStage();
        return;
    }

    // Random Movie
    if(gameState.stage > gameState.maxStage) {
        startCombat("最終BOSS", 600 + player.movieCount*100, 40 + player.movieCount*5, true);
        return;
    }

    // Plot text
    if(Math.random()<0.3) {
        if(gameState.movieName==="異形") log("雷達顯示有生物快速接近！", "log-plot");
        if(gameState.movieName==="咒怨") log("被子裡出現了一雙慘白的手...", "log-plot");
    }

    // 40% Combat, 60% Event
    if(Math.random() < 0.4) {
        const mobs = ["異形幼體", "怨靈", "木乃伊", "機器人"];
        const mob = mobs[Math.floor(Math.random()*mobs.length)];
        startCombat(mob, 150 + player.movieCount*20, 20 + player.movieCount*2);
    } else {
        generateEvent();
    }
}

/* --- Events --- */
function generateEvent() {
    const evs = [{t:"神祕寶箱", d:"路邊的金屬箱"}, {t:"求救訊號", d:"遠處的呼救聲"}, {t:"詭異祭壇", d:"散發不詳氣息"}];
    const e = evs[Math.floor(Math.random()*evs.length)];
    const choices = [
        {t:"力量破壞", check:"str", val:20},
        {t:"速度閃避", check:"agi", val:20},
        {t:"精神感知", check:"spr", val:20},
        {t:"賭運氣", check:"luc", val:15}
    ];
    showEventModal(e.t, e.d, choices);
}

function generateDeathEvent() {
    const deaths = ["廣告牌掉落", "浴室滑倒", "過山車脫軌", "鋼筋穿刺", "漏電"];
    const d = deaths[Math.floor(Math.random()*deaths.length)];
    const choices = [
        {t:"直覺閃避 (速)", check:"agi", val:25},
        {t:"強行防禦 (體)", check:"vit", val:25},
        {t:"幸運躲過 (運)", check:"luc", val:20},
        {t:"精神護盾 (精)", check:"spr", val:25}
    ];
    showEventModal(`死神設計：${d}`, "死亡陷阱觸發！", choices);
}

function triggerEventFixed(title, desc, opt1, opt2) {
    const choices = [
        {t:opt1, check:"str", val:10},
        {t:opt2, check:"int", val:10},
        {t:"防禦 (體力)", check:"vit", val:10},
        {t:"相信奇蹟 (LUC)", check:"luc", val:5}
    ];
    showEventModal(title, desc, choices);
}

function showEventModal(title, desc, choices) {
    document.getElementById('ev-title').innerText = title;
    document.getElementById('ev-desc').innerText = desc;
    const box = document.getElementById('ev-choices');
    box.innerHTML = "";
    
    if(player.teammates.some(t=>t.n==="楚軒")) {
        choices.push({t:"交給楚軒", check:"chu", val:0});
    }

    choices.forEach((c, i) => {
        const btn = document.createElement('div');
        btn.className = "choice-btn";
        if(c.check==='luc') btn.classList.add("choice-luck");
        if(c.check==='chu') btn.classList.add("choice-chu");
        
        btn.innerText = `${c.t}`;
        btn.onclick = () => resolveEvent(c);
        box.appendChild(btn);
    });
    document.getElementById('event-modal').style.display = 'flex';
}

function resolveEvent(c) {
    document.getElementById('event-modal').style.display = 'none';
    
    // Chu Xuan Logic
    if(c.check === 'chu') {
        log(" ", "log-txt");
        log("楚軒推了推眼鏡：「凡人的智慧啊... 這種簡單的佈局。」", "log-chu");
        log("你感到自尊心受創，HP -1。", "log-dmg");
        log("楚軒完美解決了事件。獲得獎勵。", "log-luck");
        player.hp -= 1;
        player.pts += 500;
        updateUI();
        if(gameState.movieName==="死神來了") nextStage(); 
        else renderStage();
        return;
    }

    // Normal Checks
    let pVal = player.stats[c.check];
    
    // Item Bonuses
    if(player.items.includes("筆記本電腦") && c.check==='int') pVal += 50; 
    if(player.items.includes("萬能鑰匙") && c.check==='agi') pVal += 50;
    if(player.items.includes("護身符") && c.check==='luc') pVal += 10;
    
    let success = false;
    if(c.check === 'luc') {
        let chance = (pVal / 50);
        if(player.movieCount === 0) chance += 0.5; // Newbie luck
        success = Math.random() < chance;
    } else {
        success = pVal >= c.val;
    }

    if(success) {
        log("判定成功！獲得獎勵點。", "log-luck");
        player.pts += 300;
    } else {
        let dmg = player.movieCount===0 ? 10 : 30;
        log(`判定失敗... 受傷 ${dmg}`, "log-dmg");
        player.hp -= dmg;
        if(player.hp <= 0) checkDeath();
    }
    updateUI();
    if(gameState.movieName==="死神來了") nextStage(); 
    else renderStage();
}

/* --- Combat --- */
function startCombat(name, hp, atk, isBoss=false) {
    combatState = { enemy: {name, hp, maxHp:hp, atk, isBoss, stun:0}, playerBuffs: {dodge:0, dmgMult:1} };
    log(`遭遇敵人：${name}`, "log-dmg");
    renderCombat();
}

function renderCombat() {
    const c = document.getElementById('controls');
    c.innerHTML = `<button class="act-btn" onclick="act('atk')">普通攻擊</button>`;
    
    if(player.skills.some(s=>s.n==="基因鎖開啟") && !gameState.geneUsed) {
        c.innerHTML += `<button class="act-btn btn-special" onclick="toggleGene()">開啟基因鎖</button>`;
    }
    player.skills.forEach(s => {
        if(s.type === 'active') c.innerHTML += `<button class="act-btn" style="color:#4fc3f7" onclick="act('skill','${s.n}')">${s.n}</button>`;
    });
    player.teammates.forEach((t, i) => {
        c.innerHTML += `<button class="act-btn btn-team" onclick="teamAct(${i})">${t.n}</button>`;
    });
}

function toggleGene() {
    gameState.geneUsed = true;
    player.geneActive = true;
    log("基因鎖開啟！", "log-luck");
    renderCombat();
    updateUI();
}

function act(type, arg) {
    let dmg = player.stats.str * 1.5;
    
    // Item Effects
    if(player.items.includes("無限沙鷹")) dmg += 40;
    if(player.items.includes("高震動粒子刀")) dmg += 90;
    if(player.items.includes("衝鋒槍")) dmg += 30;
    if(player.items.includes("匕首")) dmg += 20;
    if(player.items.includes("警槍")) dmg += 20;
    if(player.items.includes("菜刀")) dmg += 15;
    if(player.items.includes("球棒")) dmg += 15;
    if(player.items.includes("大鐵鎚")) dmg += 25;
    if(player.items.includes("扳手")) dmg += 10;
    
    if(type === 'skill') {
        const s = shopSkills.find(k=>k.n===arg) || player.skills.find(k=>k.n===arg);
        if(s.mp && player.mp < s.mp) { log("MP不足", "log-sys"); return; }
        if(s.costHp && player.hp < s.costHp) { log("HP不足", "log-sys"); return; }
        if(s.mp) player.mp -= s.mp;
        if(s.costHp) player.hp -= s.costHp;
        
        if(s.effect === 'buff') { combatState.playerBuffs.dmgMult = s.val; log("戰力倍增！", "log-skill"); }
        if(s.effect === 'dmg') { dmg = player.stats.str * s.val; log(`技能暴擊！`, "log-skill"); }
        if(s.effect === 'heal') { player.hp += s.val; log(`回復 ${s.val} HP`, "log-heal"); }
        if(s.effect === 'stun') { combatState.enemy.stun = s.val; log("敵人暈眩！", "log-skill"); }
        if(s.effect === 'block') { log("絕對防禦展開！", "log-skill"); combatState.playerBuffs.dodge = 1; }
        if(s.effect === 'crit') { dmg *= s.val; log("直死之眼！暴擊！", "log-skill"); }
    }

    if(player.geneActive) dmg *= 2;
    dmg *= combatState.playerBuffs.dmgMult;
    combatState.enemy.hp -= Math.floor(dmg);
    log(`你造成了 ${Math.floor(dmg)} 點傷害。`, "log-txt");
    
    if(player.skills.some(s=>s.effect==='suck') || player.items.includes("急救包")) {
        let heal = Math.floor(dmg * 0.1);
        if(player.skills.some(s=>s.effect==='suck')) heal = Math.floor(dmg * 0.3);
        player.hp += heal;
        log(`恢復: +${heal}`, "log-heal");
    }

    if(combatState.enemy.hp <= 0) winCombat();
    else enemyTurn();
    updateUI();
}

function teamAct(idx) {
    let t = player.teammates[idx];
    log(`${t.n} 使用技能：${t.skill.n}`, "log-skill");
    if(t.skill.type === 'dmg') { combatState.enemy.hp -= t.skill.val; log(`造成 ${t.skill.val} 傷害`, "log-dmg"); }
    if(t.skill.type === 'heal') { player.hp += t.skill.val; log(`回復 ${t.skill.val} HP`, "log-heal"); }
    if(t.skill.type === 'stun') { combatState.enemy.stun = 1; log("敵人暈眩", "log-skill"); }
    
    if(combatState.enemy.hp <= 0) winCombat();
    updateUI();
}

function enemyTurn() {
    let e = combatState.enemy;
    if(e.stun > 0) { e.stun--; log(`${e.name} 暈眩中...`, "log-sys"); combatState.playerBuffs.dmgMult=1; return; }
    
    let inc = e.atk;
    // Dodge Passive
    if(player.skills.some(s=>s.effect==='dodge')) {
        if(Math.random() < 0.4) { log("閃避成功！", "log-skill"); inc = 0; }
    }
    if(combatState.playerBuffs.dodge > 0) { inc = 0; combatState.playerBuffs.dodge = 0; }
    if(player.items.includes("防彈背心")) inc = Math.max(0, inc - 20);

    if(inc > 0) {
        player.hp -= inc;
        log(`受到 ${inc} 傷害`, "log-dmg");
    }
    combatState.playerBuffs.dmgMult = 1;
    if(player.hp <= 0) checkDeath();
}

function checkDeath() {
    if(player.movieCount === 0) {
        player.hp = 1;
        log(" ", "log-txt");
        log("====================", "log-save");
        log("就在你即將死亡時...", "log-save");
        log("資深者【張杰】出現，念動力粉碎了敵人！", "log-save");
        log("「新人！給我活下去！」", "log-save");
        log("====================", "log-save");
        setTimeout(endMovie, 2500);
    } else {
        alert("你死了... 輪迴結束。");
        location.reload();
    }
}

function winCombat() {
    log(`擊殺了 ${combatState.enemy.name}！`, "log-luck");
    player.pts += combatState.enemy.isBoss ? 2000 : 200;
    if(combatState.enemy.isBoss) {
        if(player.movieCount === 0) {
            log("解開基因鎖一階！", "log-luck");
            player.skills.push({n:"基因鎖開啟", type:"special"});
        }
        endMovie();
    } else {
        renderStage();
    }
}

function endMovie() {
    gameState.loc = "Lobby";
    player.geneActive = false;
    player.pts += 1000;
    player.hp = player.maxHp;
    player.movieCount++;
    
    // Chu Xuan Logic (After 5 movies = index 5 is 6th, wait, prompt said 5th choice fixed)
    // Let's make it so after 4 movies (entering 5th cycle) or completing 5th.
    // "第5個選擇固定增加同伴楚軒" -> Let's interpret as after Movie #4 (5th movie pending)
    
    if(player.movieCount === 4) { 
        if(!player.teammates.find(t=>t.n==="楚軒")) {
            player.teammates.push({n:"楚軒", skill:{n:"智謀", type:"stun", val:2, d:"全局佈局"}});
            log("【楚軒】加入了隊伍。", "log-luck");
            log("提示：以後奇遇可交給楚軒解決。", "log-sys");
        }
    } else {
        let mate = teammatePool[Math.floor(Math.random()*teammatePool.length)];
        if(!player.teammates.find(t=>t.n===mate.n)) {
            player.teammates.push(mate);
            log(`${mate.n} 加入隊伍！`, "log-luck");
        } else {
            log("獲得 D級支線劇情 x1", "log-luck");
        }
    }
    
    renderLobby();
}

/* --- Shop --- */
function openShop() { document.getElementById('shop-modal').style.display = 'flex'; renderShop('items'); }
function renderShop(type) {
    const list = document.getElementById('shop-content');
    list.innerHTML = "";
    const db = type === 'items' ? shopItems : shopSkills;
    db.forEach(i => {
        const owned = player.items.includes(i.n) || player.skills.some(s=>s.n===i.n);
        const d = document.createElement('div');
        d.className = "shop-item";
        d.innerHTML = `<div><div style="color:${type==='items'?'var(--rare)':'#4fc3f7'}">${i.n}</div><div style="font-size:0.8em;color:#aaa">${i.d}</div></div>
        <button class="btn-buy" ${owned?'disabled':''} onclick="buy('${i.n}',${i.c},'${type}')">${owned?'已擁有':i.c}</button>`;
        list.appendChild(d);
    });
}
function buy(n,c,type) {
    if(player.pts >= c) {
        player.pts -= c;
        if(type==='items') player.items.push(n);
        else player.skills.push(type==='items'?shopItems.find(x=>x.n===n):shopSkills.find(x=>x.n===n));
        renderShop(type);
        updateUI();
    } else alert("點數不足");
}
</script>
</body>
</html>
