<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>無限恐怖：無限輪迴 (新手保護版)</title>
    <style>
        :root { --bg: #050505; --term: #33ff00; --ui: #1a1a1a; --bd: #444; --acc: #b71c1c; }
        body { background: var(--bg); color: #ccc; font-family: 'Microsoft JhengHei', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Intro */
        #intro-win { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; justify-content:center; align-items:center; }
        .win-box { background:#c0c0c0; border:2px outset #fff; width:90%; max-width:350px; padding:2px; box-shadow:5px 5px 0 #333; color:black;}
        .win-head { background:#000080; color:white; padding:3px; font-weight:bold; display:flex; justify-content:space-between; }
        .win-content { padding:20px; text-align:center; font-size:1.1em; }
        .win-btn { border:2px outset white; background:#c0c0c0; padding:5px 15px; cursor:pointer; margin:5px; font-weight:bold; }
        
        /* Job Select */
        #char-select { display:none; flex-direction:column; align-items:center; height:100%; padding:10px; background: #111; }
        .job-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; max-width:600px; flex:1; overflow-y:auto; padding-bottom: 10px;}
        .job-card { 
            background: #222; border:1px solid #444; padding:10px; cursor:pointer; font-size: 0.85em; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .job-card.selected { border: 2px solid var(--acc); background:#2d1a1a; }
        .job-stat-row { color: #888; font-size: 0.9em; margin-top: 2px; }
        .job-special { color: #ffeb3b; font-weight: bold; margin-top: 5px; }

        /* Main UI */
        #main-ui { display:none; height:100%; flex-direction:column; }
        header { background:#111; padding:8px; border-bottom:1px solid var(--acc); display:flex; justify-content:space-between; align-items:center; font-size: 0.85em; flex-shrink: 0;}
        
        #game-body { flex:1; display:flex; overflow:hidden; }
        
        /* Sidebar (Left) */
        #sidebar { 
            flex: 0 0 28%; background:#111; border-right:1px solid #333; padding:5px; overflow-y:auto; font-size:0.75em; 
        }
        /* Log Area (Right) */
        #log-area { 
            flex: 1; background:black; padding:10px; overflow-y:auto; font-family:'Consolas', monospace; line-height:1.5; font-size: 0.9em;
        }
        
        .stat-row { display:flex; justify-content:space-between; margin-bottom: 3px; }
        .plus-btn { width: 16px; height: 16px; font-size: 10px; padding: 0; line-height: 16px; background: #333; color: white; border: 1px solid #555; }

        /* Log Colors */
        .log-txt { margin-bottom:5px; color:#aaa; }
        .log-sys { color:yellow; }
        .log-dmg { color:#ff4444; }
        .log-heal { color:#00e676; }
        .log-skill { color:#00b0ff; font-weight:bold; }
        .log-luck { color:gold; text-shadow:0 0 5px orange; font-weight:bold; }
        .log-save { color:#e040fb; font-weight:bold; border: 1px dashed #e040fb; padding: 5px; margin: 5px 0; }
        
        /* Controls */
        #controls { padding:5px; background:#1a1a1a; display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; border-top:1px solid #333; min-height: 60px; flex-shrink: 0;}
        button.act-btn { background:#333; color:#eee; border:1px solid #555; padding:8px; cursor:pointer; border-radius:2px; font-size:0.85em; }
        button.btn-special { background:#b71c1c; border-color:#ff5252; color:white; }
        button.btn-team { background:#0d47a1; color:#fff; border-color:#2979ff; grid-column: span 2; }
        
        /* Modals */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; display:none; justify-content:center; align-items:center; }
        .event-box { width:90%; max-width:500px; background:#222; border:2px solid var(--term); padding:15px; display:flex; flex-direction:column; }
        .choice-btn { background:#333; color:white; border:1px solid #555; padding:12px; margin-bottom:8px; text-align:left; cursor:pointer; }
        .choice-luck { border-color: gold; color: gold; font-weight:bold; }

        .shop-box { width:95%; height:85vh; background:#222; border:1px solid #555; display:flex; flex-direction:column; }
        .shop-list { flex:1; overflow-y:auto; display:grid; grid-template-columns: 1fr; gap:5px; padding:5px; }
        .shop-item { border:1px solid #444; padding:8px; display:flex; justify-content:space-between; align-items:center; }
    </style>
</head>
<body>

<!-- 1. Intro -->
<div id="intro-win">
    <div class="win-box">
        <div class="win-head"><span>SYSTEM_ALERT</span><span>X</span></div>
        <div class="win-content">
            <p>想明白生命的意義嗎？</p>
            <p>想真正的...活著嗎？</p>
            <div style="margin-top:20px;">
                <button class="win-btn" onclick="goToSelect()">YES</button>
                <button class="win-btn" onclick="window.close()">NO</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. Select Job -->
<div id="char-select">
    <div style="width:100%; display:flex; justify-content:space-between; align-items:center; padding-bottom:10px;">
        <h3 style="color:var(--acc); margin:0;">選擇前世身份</h3>
        <button class="act-btn" style="padding:5px 15px;" onclick="refreshJobs()">刷新列表</button>
    </div>
    
    <div class="job-grid" id="job-container"></div>
    
    <div style="margin-top:10px; width:100%; text-align:center; padding-top:10px; border-top:1px solid #333;">
        <input type="text" id="player-name" value="鄭吒" style="padding:8px; width:120px; background:#222; border:1px solid #555; color:white;">
        <button class="act-btn" style="background:var(--acc); width:100px;" onclick="startGame()">確認開始</button>
    </div>
</div>

<!-- 3. Main Game -->
<div id="main-ui">
    <header>
        <div><span id="ui-name"></span> | <span style="color:gold" id="ui-pts">0</span> 點</div>
        <div id="ui-loc" style="color:#00e676">主神空間</div>
    </header>
    
    <div id="game-body">
        <div id="sidebar">
            <div style="border-bottom:1px solid #444; margin-bottom:5px; color:#fff;">屬性</div>
            <div id="stat-list"></div>
            <div style="border-bottom:1px solid #444; margin:15px 0 5px 0; color:#fff;">裝備</div>
            <div id="inv-list"></div>
            <div style="border-bottom:1px solid #444; margin:15px 0 5px 0; color:#fff;">技能/血統</div>
            <div id="skill-list"></div>
            <div style="border-bottom:1px solid #444; margin:15px 0 5px 0; color:#fff;">隊伍</div>
            <div id="team-list" style="font-size:0.9em; color:#81d4fa;"></div>
        </div>
        
        <div id="log-area">
            <div class="log-sys">連接主神光球... 數據同步完成。</div>
        </div>
    </div>
    
    <div id="controls"></div>
</div>

<!-- Events -->
<div id="event-modal" class="modal">
    <div class="event-box">
        <div style="color:var(--term); font-size:1.2em; font-weight:bold; margin-bottom:10px;" id="ev-title"></div>
        <div style="margin-bottom:15px; color:#eee;" id="ev-desc"></div>
        <div id="ev-choices" style="display:flex; flex-direction:column;"></div>
    </div>
</div>

<!-- Shop -->
<div id="shop-modal" class="modal">
    <div class="shop-box">
        <div style="display:flex;">
            <button class="act-btn" style="flex:1" onclick="renderShop('items')">道具</button>
            <button class="act-btn" style="flex:1" onclick="renderShop('skills')">技能</button>
            <button class="act-btn" style="background:#b71c1c;" onclick="document.getElementById('shop-modal').style.display='none'">X</button>
        </div>
        <div class="shop-list" id="shop-content"></div>
    </div>
</div>

<script>
/* --- 1. Database --- */
const skillsDB = [
    {n:"蜘蛛感應", type:"passive", effect:"dodge", val:0.3, d:"危險感知，被動增加30%閃避率"},
    {n:"吸血鬼血統", type:"passive", effect:"suck", val:0.3, d:"造成傷害的30%轉化為生命"},
    {n:"爆炸", c:2000, type:"active", effect:"buff", val:3, costHp:20, d:"消耗20HP，本回合攻擊x3"},
    {n:"心靈震爆", c:1500, type:"active", effect:"stun", val:1, mp:30, d:"擊暈敵人1回合"},
    {n:"紅炎", c:1500, type:"active", effect:"dmg", val:2.5, mp:20, d:"2.5倍力量傷害"},
    {n:"治癒術", c:800, type:"active", effect:"heal", val:100, mp:40, d:"回復100點生命"},
    {n:"點線魔眼", c:3000, type:"active", effect:"crit", val:4, mp:50, d:"無視防禦4倍傷害"}
];

const itemsDB = [
    {n:"無限沙鷹", c:500, type:"weapon", atk:30, d:"攻+30"},
    {n:"高斯狙擊槍", c:3000, type:"weapon", atk:200, d:"攻+200"},
    {n:"止血噴霧", c:100, type:"consumable", effect:"heal", val:150, d:"回150HP"},
    {n:"匕首", c:0, type:"weapon", atk:10, d:"攻+10"},
    {n:"手槍", c:0, type:"weapon", atk:15, d:"攻+15"},
    {n:"電腦", c:0, type:"tool", d:"黑客工具"},
    {n:"復活真經(殘)", c:8000, type:"special", d:"復活隊友"}
];

const teammatePool = [
    {n:"零點", skill:{n:"狙擊", type:"dmg", val:300}},
    {n:"詹嵐", skill:{n:"治療", type:"heal", val:150}},
    {n:"趙櫻空", skill:{n:"刺殺", type:"dmg", val:200}},
    {n:"張杰", skill:{n:"念動力", type:"stun", val:1}}
];

// Special Jobs Data
const specialJobs = [
    {n:"吸血鬼後裔", s:{str:10, agi:10, vit:10, int:10, spr:10, luc:5}, item:null, skill:"吸血鬼血統", d:"屬性平均，天生擁有血族力量。"},
    {n:"友善好鄰居", s:{str:8, agi:20, vit:8, int:10, spr:10, luc:10}, item:null, skill:"蜘蛛感應", d:"【隱藏效果】看似普通學生，其實..."},
    {n:"古武傳人", s:{str:15, agi:12, vit:12, int:5, spr:10, luc:5}, item:null, skill:"爆炸", d:"天生懂得控制內氣爆發。"}
];

// Random Job Generator
const jobPrefix = ["特種","天才","瘋狂","落魄","實習","資深"];
const jobBase = [
    {n:"兵", max:"str", item:"手槍"}, {n:"黑客", max:"int", item:"電腦"}, {n:"殺手", max:"agi", item:"匕首"},
    {n:"醫生", max:"int", item:"止血噴霧"}, {n:"運動員", max:"vit", item:null}, {n:"賭徒", max:"luc", item:null}
];

function generateRandomJobs() {
    let res = [];
    // 1. Add 1-2 Special Jobs
    let spec = [...specialJobs].sort(()=>Math.random()-0.5);
    res.push(spec[0]);
    if(Math.random()>0.5) res.push(spec[1]);

    // 2. Fill with random jobs until 10
    while(res.length < 10) {
        let base = jobBase[Math.floor(Math.random()*jobBase.length)];
        let pre = jobPrefix[Math.floor(Math.random()*jobPrefix.length)];
        let stats = {str:5, agi:5, vit:5, int:5, spr:5, luc:5};
        
        // Randomize stats
        for(let k in stats) stats[k] += Math.floor(Math.random()*5);
        stats[base.max] += 10; // Main stat boost

        res.push({
            n: pre + base.n,
            s: stats,
            item: base.item,
            skill: null,
            d: `擅長${base.max.toUpperCase()}領域`
        });
    }
    return res;
}

/* --- 2. State --- */
let player = { n:"", hp:100, maxHp:100, mp:100, maxMp:100, pts:0, items:[], skills:[], stats:{}, teammates:[], geneActive:false };
let gameState = { loc: "Lobby", movieName: "", stage: 0, maxStage: 0, isFirst: true, geneUsed: false };
let combatState = { enemy:null, playerBuffs:{} };
let currentJobs = [];
let selectedJob = null;

/* --- 3. Functions --- */

function goToSelect() {
    document.getElementById('intro-win').style.display = 'none';
    document.getElementById('char-select').style.display = 'flex';
    refreshJobs();
}

function refreshJobs() {
    currentJobs = generateRandomJobs();
    const c = document.getElementById('job-container');
    c.innerHTML = "";
    selectedJob = null;
    
    currentJobs.forEach(j => {
        const d = document.createElement('div');
        d.className = "job-card";
        
        let statTxt = `力${j.s.str} 速${j.s.agi} 體${j.s.vit} 智${j.s.int}`;
        let itemTxt = j.item ? `物品: ${j.item}` : "物品: 無";
        let skillTxt = j.skill ? `<div class="job-special">天賦: ${j.skill}</div>` : "";
        if(j.n === "友善好鄰居") skillTxt = `<div class="job-special" style="color:#aaa">天賦: ??? (隱藏)</div>`;

        d.innerHTML = `
            <div style="font-weight:bold; color:white; font-size:1.1em; border-bottom:1px solid #444; padding-bottom:5px;">${j.n}</div>
            <div class="job-stat-row">${statTxt}</div>
            <div class="job-stat-row">${itemTxt}</div>
            ${skillTxt}
        `;
        d.onclick = () => {
            document.querySelectorAll('.job-card').forEach(x=>x.classList.remove('selected'));
            d.classList.add('selected');
            selectedJob = j;
        }
        c.appendChild(d);
    });
}

function startGame() {
    if(!selectedJob) { alert("請選擇一個身份！"); return; }
    const name = document.getElementById('player-name').value;
    
    player.n = name;
    player.stats = {...selectedJob.s};
    if(selectedJob.item) player.items.push(selectedJob.item);
    
    // Handle Special Skill
    if(selectedJob.skill) {
        let skillData = skillsDB.find(s=>s.n === selectedJob.skill);
        if(skillData) player.skills.push(skillData);
    }
    
    // Calc Derived Stats
    player.maxHp = player.stats.vit * 10 + 50;
    player.hp = player.maxHp;
    player.maxMp = player.stats.spr * 5 + 50;
    player.mp = player.maxMp;

    document.getElementById('char-select').style.display = 'none';
    document.getElementById('main-ui').style.display = 'flex';
    updateUI();
    log("傳送完成。歡迎來到主神空間。", "log-sys");
    if(selectedJob.n === "友善好鄰居") log("你的【蜘蛛感應】正在運作...", "log-skill");
    
    renderLobby();
}

function updateUI() {
    document.getElementById('ui-name').innerText = player.n;
    document.getElementById('ui-pts').innerText = player.pts;
    document.getElementById('ui-loc').innerText = gameState.loc === "Lobby" ? "主神空間" : gameState.movieName;

    const s = player.stats;
    const slist = document.getElementById('stat-list');
    let isLobby = gameState.loc === "Lobby";
    
    let h = `<div class="stat-row">HP <span style="color:#ff4444">${Math.floor(player.hp)}/${player.maxHp}</span></div>`;
    h += `<div class="stat-row">MP <span style="color:#4fc3f7">${Math.floor(player.mp)}/${player.maxMp}</span></div>`;
    
    ["str","agi","vit","int","spr","luc"].forEach(k => {
        let label = {str:"力",agi:"速",vit:"體",int:"智",spr:"精",luc:"運"}[k];
        let btn = isLobby ? `<button class="plus-btn" onclick="upStat('${k}')">+</button>` : "";
        h += `<div class="stat-row"><span>${label}:${s[k]}</span> ${btn}</div>`;
    });
    slist.innerHTML = h;

    document.getElementById('inv-list').innerHTML = player.items.map(i=>`<div>·${i}</div>`).join('');
    document.getElementById('skill-list').innerHTML = player.skills.map(k=>`<div>★${k.n}</div>`).join('');
    document.getElementById('team-list').innerHTML = player.teammates.map(t=>`<div>☺${t.n}</div>`).join('');
}

function log(msg, cls="log-txt") {
    const d = document.createElement('div');
    d.className = cls;
    d.innerHTML = `> ${msg}`;
    const area = document.getElementById('log-area');
    area.appendChild(d);
    area.scrollTop = area.scrollHeight;
}

function upStat(k) {
    if(player.pts >= 100) {
        player.pts -= 100;
        player.stats[k] += 5;
        if(k==='vit') { player.maxHp+=50; player.hp+=50; }
        if(k==='spr') { player.maxMp+=25; player.mp+=25; }
        updateUI();
    }
}

/* --- Game Loop --- */

function renderLobby() {
    gameState.loc = "Lobby";
    updateUI();
    const c = document.getElementById('controls');
    c.innerHTML = `
        <button class="act-btn btn-special" style="grid-column: span 2" onclick="startMovie()">進入恐怖片</button>
        <button class="act-btn" onclick="openShop()">兌換</button>
        <button class="act-btn" onclick="fullHeal()">全身修復(50)</button>
    `;
}

function fullHeal() {
    if(player.pts >= 50) {
        player.pts -= 50;
        player.hp = player.maxHp;
        player.mp = player.maxMp;
        updateUI();
        log("全身修復完畢。", "log-heal");
    }
}

function startMovie() {
    gameState.loc = "Movie";
    gameState.stage = 0;
    gameState.geneUsed = false;
    
    if(gameState.isFirst) {
        gameState.movieName = "生化危機一";
        gameState.maxStage = 5;
        log("目標：生化危機一 (新手難度)", "log-sys");
        log("提示：第一關奇遇成功率大幅提升。", "log-skill");
    } else {
        const titles = ["異形", "咒怨", "神鬼傳奇", "死神來了"];
        gameState.movieName = titles[Math.floor(Math.random()*titles.length)];
        gameState.maxStage = 8;
        log(`目標：${gameState.movieName}`, "log-sys");
    }
    updateUI();
    renderStage();
}

function renderStage() {
    const c = document.getElementById('controls');
    c.innerHTML = `<button class="act-btn" style="grid-column: span 4; background:#333; height:45px;" onclick="nextStage()">繼續前進</button>`;
}

function nextStage() {
    gameState.stage++;
    if(gameState.stage > gameState.maxStage) {
        let bossName = gameState.isFirst ? "爬行者(弱化版)" : "位面夢魘";
        let bossHp = gameState.isFirst ? 150 : 600;
        startCombat(bossName, bossHp, 20, true);
        return;
    }

    // 40% Combat, 60% Event
    if(Math.random() < 0.4) {
        let mobHp = gameState.isFirst ? 60 : 120 + gameState.stage*20;
        let mobAtk = gameState.isFirst ? 10 : 20 + gameState.stage*2;
        startCombat("怪物", mobHp, mobAtk);
    } else {
        generateEvent();
    }
}

/* --- Events --- */
function generateEvent() {
    const evs = [{t:"寶箱", d:"路邊的箱子"},{t:"求救", d:"遠處的呼救"},{t:"祭壇", d:"詭異的祭壇"}];
    const e = evs[Math.floor(Math.random()*evs.length)];
    const choices = [
        {t:"力量破壞", check:"str", val:15},
        {t:"速度閃避", check:"agi", val:15},
        {t:"精神感知", check:"spr", val:15},
        {t:"賭運氣", check:"luc", val:10}
    ];
    
    document.getElementById('ev-title').innerText = e.t;
    document.getElementById('ev-desc').innerText = e.d;
    const box = document.getElementById('ev-choices');
    box.innerHTML = "";
    
    choices.forEach((c,i) => {
        const btn = document.createElement('div');
        btn.className = "choice-btn";
        if(i===3) btn.classList.add("choice-luck");
        btn.innerText = `${c.t} (${c.check.toUpperCase()})`;
        btn.onclick = () => resolveEvent(c);
        box.appendChild(btn);
    });
    document.getElementById('event-modal').style.display = 'flex';
}

function resolveEvent(c) {
    document.getElementById('event-modal').style.display = 'none';
    let pVal = player.stats[c.check];
    
    // Difficulty logic: First movie is MUCH easier (60% base chance boost or lower threshold)
    let success = false;
    
    if(c.check === 'luc') {
        let chance = (pVal / 50); 
        if(gameState.isFirst) chance += 0.6; // 60% Bonus chance for first level
        success = Math.random() < chance;
    } else {
        let threshold = c.val;
        if(gameState.isFirst) threshold = 5; // Very low threshold for first level
        success = pVal >= threshold;
    }

    if(success) {
        log("奇遇成功！獲得獎勵點。", "log-luck");
        player.pts += 300;
    } else {
        let dmg = gameState.isFirst ? 10 : 30;
        log(`奇遇失敗... 受傷 ${dmg}`, "log-dmg");
        player.hp -= dmg;
        if(player.hp <= 0) checkDeath();
    }
    updateUI();
}

/* --- Combat --- */
function startCombat(name, hp, atk, isBoss=false) {
    combatState = {
        enemy: {name, hp, maxHp:hp, atk, isBoss},
        playerBuffs: {dodge:0, dmgMult:1}
    };
    log(`遭遇敵人: ${name}`, "log-dmg");
    renderCombat();
}

function renderCombat() {
    const c = document.getElementById('controls');
    c.innerHTML = `<button class="act-btn" onclick="act('atk')">攻擊</button>`;
    
    // Skills
    player.skills.forEach(s => {
        if(s.type === 'active') {
            c.innerHTML += `<button class="act-btn" style="color:#4fc3f7" onclick="act('skill','${s.n}')">${s.n}</button>`;
        }
    });

    // Teammates
    player.teammates.forEach((t, i) => {
        c.innerHTML += `<button class="act-btn btn-team" onclick="teamAct(${i})">${t.n}</button>`;
    });
}

function act(type, arg) {
    let dmg = player.stats.str * 1.5;
    
    // Weapon bonus
    const wpn = player.items.find(i => itemsDB.find(db=>db.n===i && db.type==='weapon'));
    if(wpn) dmg += itemsDB.find(db=>db.n===wpn).atk;

    if(type === 'skill') {
        const s = skillsDB.find(k=>k.n===arg);
        if(s.mp && player.mp < s.mp) { log("MP不足", "log-sys"); return; }
        if(s.costHp && player.hp < s.costHp) { log("HP不足", "log-sys"); return; }
        if(s.mp) player.mp -= s.mp;
        if(s.costHp) player.hp -= s.costHp;
        
        if(s.effect === 'buff') { combatState.playerBuffs.dmgMult = s.val; log("攻擊倍率上升！", "log-skill"); }
        if(s.effect === 'dmg') { dmg = player.stats.str * s.val; log(`技能暴擊！`, "log-skill"); }
        if(s.effect === 'heal') { player.hp += s.val; log(`回復 ${s.val} HP`, "log-heal"); }
        if(s.effect === 'stun') { combatState.enemy.stun = s.val; log("擊暈敵人", "log-skill"); }
    }

    dmg *= combatState.playerBuffs.dmgMult;
    combatState.enemy.hp -= Math.floor(dmg);
    log(`造成 ${Math.floor(dmg)} 傷害`, "log-txt");

    // Lifesteal Passive
    let vampire = player.skills.find(s=>s.n==="吸血鬼血統");
    if(vampire) {
        let heal = Math.floor(dmg * vampire.val);
        player.hp += heal;
        log(`吸血: +${heal}`, "log-heal");
    }

    if(combatState.enemy.hp <= 0) {
        winCombat();
    } else {
        enemyTurn();
    }
    updateUI();
}

function teamAct(idx) {
    let t = player.teammates[idx];
    log(`${t.n} 發動技能！`, "log-skill");
    if(t.skill.type === 'dmg') {
        combatState.enemy.hp -= t.skill.val;
        log(`隊友造成 ${t.skill.val} 傷害`, "log-dmg");
    }
    if(t.skill.type === 'heal') {
        player.hp += t.skill.val;
        log(`隊友回復你 ${t.skill.val} HP`, "log-heal");
    }
    if(t.skill.type === 'stun') {
        combatState.enemy.stun = 1;
        log(`隊友擊暈了敵人`, "log-skill");
    }
    // Simple logic: remove teammate button for this fight or just let them spam (keeping simple here)
    if(combatState.enemy.hp <= 0) winCombat();
    updateUI();
}

function enemyTurn() {
    let e = combatState.enemy;
    if(e.stun > 0) {
        e.stun--;
        log("敵人暈眩中...", "log-sys");
        return;
    }
    
    let inc = e.atk;
    
    // Dodge Passive
    let spidey = player.skills.find(s=>s.n==="蜘蛛感應");
    if(spidey && Math.random() < spidey.val) {
        log("【蜘蛛感應】閃避了攻擊！", "log-skill");
        inc = 0;
    }

    if(inc > 0) {
        player.hp -= inc;
        log(`受到 ${inc} 傷害`, "log-dmg");
    }

    if(player.hp <= 0) {
        checkDeath();
    }
}

function checkDeath() {
    // FIX 2: Zhang Jie Safety Net
    if(gameState.isFirst) {
        player.hp = 1; // Prevent actual death
        log("====================", "log-save");
        log("就在你即將死亡的一刻...", "log-save");
        log("「新人！別死在這裡！」", "log-save");
        log("資深者【張杰】突然出現，念動力瞬間粉碎了怪物！", "log-save");
        log("「這次算你運氣好...回主神空間吧。」", "log-save");
        log("====================", "log-save");
        
        // Treat as win but skip loot maybe? Or just proceed.
        setTimeout(() => endMovie(), 2000);
    } else {
        alert("你死了... 遊戲結束。");
        location.reload();
    }
}

function winCombat() {
    log("戰鬥勝利！", "log-luck");
    player.pts += 200;
    if(combatState.enemy.isBoss) {
        endMovie();
    } else {
        renderStage();
    }
}

function endMovie() {
    gameState.loc = "Lobby";
    player.pts += 1000;
    player.hp = player.maxHp;
    
    if(gameState.isFirst) gameState.isFirst = false;
    
    // Add teammate
    let mate = teammatePool[Math.floor(Math.random()*teammatePool.length)];
    if(!player.teammates.find(t=>t.n===mate.n)) {
        player.teammates.push(mate);
        log(`${mate.n} 加入隊伍！`, "log-heal");
    }
    
    renderLobby();
}

/* Shop Logic */
function openShop() {
    document.getElementById('shop-modal').style.display = 'flex';
    renderShop('items');
}
function renderShop(type) {
    const list = document.getElementById('shop-content');
    list.innerHTML = "";
    const db = type === 'items' ? itemsDB : skillsDB;
    db.forEach(i => {
        if(i.c > 0) { // Don't show starter items
            const d = document.createElement('div');
            d.className = "shop-item";
            d.innerHTML = `<div><div style="color:gold">${i.n}</div><div style="font-size:0.8em;color:#aaa">${i.d}</div></div><button class="act-btn" onclick="buy('${i.n}',${i.c},'${type}')">${i.c}</button>`;
            list.appendChild(d);
        }
    });
}
function buy(n,c,type) {
    if(player.pts >= c) {
        player.pts -= c;
        if(type==='items') player.items.push(n);
        else player.skills.push(skillsDB.find(s=>s.n===n));
        log(`購買 ${n}`, "log-heal");
        updateUI();
    } else alert("點數不足");
}
</script>
</body>
</html>
